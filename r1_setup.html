<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>C·∫•u h√¨nh WiFi + Qu√©t IP loa R1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- jQuery gi·ªëng b·∫£n g·ªëc -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-soft: #dbeafe;
            --danger: #ef4444;
            --bg: #0f172a;
            --card-bg: rgba(15, 23, 42, 0.9);
            --text-main: #e5e7eb;
            --text-sub: #9ca3af;
            --border-soft: rgba(148, 163, 184, 0.4);
            --radius-xl: 18px;
            --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.55);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background:
                radial-gradient(circle at top left, #38bdf8 0, transparent 55%),
                radial-gradient(circle at bottom right, #22c55e 0, transparent 55%),
                linear-gradient(135deg, #020617, #0f172a);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            padding: 16px;
        }

        .glass-card {
            width: 100%;
            max-width: 520px;
            background: var(--card-bg);
            border-radius: var(--radius-xl);
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: var(--shadow-soft);
            backdrop-filter: blur(22px);
            padding: 22px 22px 18px;
            position: relative;
            overflow: hidden;
        }
        .glass-card::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.25), transparent 55%);
            opacity: 0.7;
            pointer-events: none;
        }
        .card-inner { position: relative; z-index: 1; }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        .icon-circle {
            width: 42px;
            height: 42px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, #60a5fa, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.5);
        }
        .card-title {
            font-size: 18px;
            font-weight: 650;
            margin: 0;
        }
        .card-subtitle {
            margin: 2px 0 0;
            font-size: 13px;
            color: var(--text-sub);
        }

        .steps-box {
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px dashed var(--border-soft);
            background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.16), transparent 55%),
                        rgba(15, 23, 42, 0.9);
            font-size: 12px;
            max-height: 170px;
            overflow-y: auto;
        }
        .steps-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: #bfdbfe;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }
        .steps-title span.icon {
            width: 16px;
            height: 16px;
            border-radius: 999px;
            background: rgba(59, 130, 246, 0.4);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }
        .steps-list {
            margin: 0;
            padding-left: 18px;
            color: var(--text-sub);
        }
        .steps-list li { margin-bottom: 4px; }
        .steps-note {
            margin-top: 6px;
            color: #f97316;
            font-size: 11px;
        }

        .section-title {
            margin: 14px 0 6px;
            font-size: 13px;
            font-weight: 600;
            color: #bfdbfe;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-title small {
            font-size: 11px;
            color: var(--text-sub);
        }

        .field { margin-bottom: 10px; text-align: left; }
        .field-label {
            font-size: 12px;
            margin-bottom: 4px;
            color: var(--text-sub);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .field-label span.right-hint {
            font-size: 11px;
            opacity: 0.8;
        }

        .input, select {
            width: 100%;
            padding: 9px 11px;
            border-radius: 10px;
            border: 1px solid var(--border-soft);
            background: rgba(15, 23, 42, 0.9);
            color: var(--text-main);
            font-size: 14px;
            outline: none;
            transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
        }
        .input::placeholder { color: rgba(148, 163, 184, 0.7); }
        .input:focus, select:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.7);
            background: rgba(15, 23, 42, 1);
        }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 14px;
        }
        .btn {
            flex: 1;
            padding: 9px 12px;
            border-radius: 999px;
            border: 0;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease, opacity 0.12s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn-icon { font-size: 16px; }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #e5e7eb;
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.6);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 30px rgba(37, 99, 235, 0.8);
        }
        .btn-secondary {
            background: rgba(15, 23, 42, 0.95);
            color: var(--text-sub);
            border: 1px solid rgba(148, 163, 184, 0.6);
        }
        .btn-secondary:hover {
            background: rgba(15, 23, 42, 1);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: default;
            transform: none;
            box-shadow: none;
        }

        .message {
            margin-top: 10px;
            font-size: 12px;
            text-align: left;
            min-height: 16px;
        }
        .message-success { color: #4ade80; }
        .message-error   { color: #fb7185; }
        .message-info    { color: #93c5fd; }

        .scan-note {
            font-size: 11px;
            color: var(--text-sub);
            margin-top: 4px;
        }
        .scan-result {
            margin-top: 6px;
            font-size: 12px;
        }
        .scan-result strong {
            color: #facc15;
        }

        @media (max-width: 520px) {
            .glass-card { padding: 18px 16px 14px; }
        }
    </style>
</head>
<body>

<div class="glass-card">
    <div class="card-inner">
        <div class="card-header">
            <div class="icon-circle">R1</div>
            <div>
                <h1 class="card-title">C·∫•u h√¨nh WiFi & qu√©t IP loa R1</h1>
                <p class="card-subtitle">
                    G·ª≠i WiFi cho loa R1 v√† h·ªó tr·ª£ d√≤ IP loa trong m·∫°ng LAN (kh√¥ng qu√©t port).
                </p>
            </div>
        </div>

        <!-- H∆Ø·ªöNG D·∫™N -->
        <div class="steps-box">
            <div class="steps-title">
                <span class="icon">?</span>
                H∆∞·ªõng d·∫´n c·∫•u h√¨nh WiFi cho R1
            </div>
            <ol class="steps-list">
                <li>Nh·∫•n v√† gi·ªØ n√∫t tr√™n ƒë·ªânh loa R1 kho·∫£ng 5 gi√¢y cho ƒë·∫øn khi loa b√°o
                    <strong>"B·∫Øt ƒë·∫ßu c·∫•u h√¨nh m·∫°ng"</strong> (ƒë√®n tr·∫Øng nh·∫•p nh√°y).
                </li>
                <li>Tr√™n ƒëi·ªán tho·∫°i, v√†o WiFi v√† k·∫øt n·ªëi v·ªõi
                    <strong>Phicomm_R1_XXXX</strong>.
                </li>
                <li>M·ªü trang n√†y, nh·∫≠p WiFi nh√† b·∫°n b√™n d∆∞·ªõi r·ªìi b·∫•m
                    <strong>G·ª≠i c·∫•u h√¨nh WiFi</strong>.
                </li>
            </ol>
            <div class="steps-note">
                üëâ N√™n t·∫Øt <strong>4G/5G</strong> tr√™n ƒëi·ªán tho·∫°i ƒë·ªÉ request ƒëi qua WiFi R1, tr√°nh l·ªói ·∫£o.
            </div>
        </div>

        <!-- FORM C·∫§U H√åNH WIFI -->
        <div class="section-title">
            <span>Th√¥ng tin WiFi nh√† b·∫°n</span>
            <small>API: 192.168.43.1:8989/api/configwifi</small>
        </div>

        <form id="wifiForm" autocomplete="on" novalidate>
            <div class="field">
                <label class="field-label" for="ssid">
                    <span>T√™n WiFi (SSID)</span>
                    <span class="right-hint">V√≠ d·ª•: MyHome_5G</span>
                </label>
                <input
                    type="text"
                    id="ssid"
                    name="ssid"
                    class="input"
                    placeholder="Nh·∫≠p t√™n WiFi b·∫°n mu·ªën cho R1 k·∫øt n·ªëi"
                    required
                >
            </div>

            <div class="field">
                <label class="field-label" for="encryption">
                    <span>Ki·ªÉu m√£ h√≥a</span>
                    <span class="right-hint">Th∆∞·ªùng l√† WPA/WPA2</span>
                </label>
                <select id="encryption" name="encryption" class="input" required>
                    <option value="INSECURE">Kh√¥ng m√£ h√≥a (INSECURE)</option>
                    <option value="WEP">WEP</option>
                    <option value="WPA" selected>WPA / WPA2</option>
                </select>
            </div>

            <div class="field">
                <label class="field-label" for="password">
                    <span>M·∫≠t kh·∫©u WiFi</span>
                    <span class="right-hint">T·ªëi thi·ªÉu 8 k√Ω t·ª±</span>
                </label>
                <input
                    type="password"
                    id="password"
                    name="password"
                    class="input"
                    placeholder="Nh·∫≠p m·∫≠t kh·∫©u WiFi nh√† b·∫°n"
                    required
                >
            </div>

            <div class="btn-row">
                <button type="submit" id="configBtn" class="btn btn-primary">
                    <span class="btn-icon">üì°</span>
                    <span>G·ª≠i c·∫•u h√¨nh WiFi</span>
                </button>
                <button type="button" id="resetBtn" class="btn btn-secondary">
                    <span class="btn-icon">‚ôª</span>
                    <span>Xo√° & nh·∫≠p l·∫°i</span>
                </button>
            </div>
        </form>

        <div id="message" class="message message-info">
            ƒêi·ªÅn th√¥ng tin WiFi r·ªìi b·∫•m ‚ÄúG·ª≠i c·∫•u h√¨nh WiFi‚Äù.
        </div>

       

        <div id="scanResult" class="scan-result"></div>
    </div>
</div>

<script>
    // API config WiFi tr√™n R1 khi ƒëang ·ªü ch·∫ø ƒë·ªô AP
    const R1_API_URL = "http://192.168.43.1:8989/api/configwifi";

    let sendTimer = null;       // gi·ªëng window.timer
    let requestStarted = false; // ƒë√°nh d·∫•u ƒë√£ g·ª≠i request

    function restoreLastValues() {
        const ssidInput = document.getElementById("ssid");
        const encSelect = document.getElementById("encryption");
        const pwdInput  = document.getElementById("password");

        const savedSsid   = sessionStorage.getItem("ssid") || "";
        const savedSecure = sessionStorage.getItem("secure") || "";
        const savedPwd    = sessionStorage.getItem("password") || "";

        ssidInput.value = savedSsid;
        if (savedSecure) encSelect.value = savedSecure;
        pwdInput.value = savedPwd;
    }

    function saveValues(ssid, secure, password) {
        sessionStorage.setItem("ssid", ssid);
        sessionStorage.setItem("secure", secure);
        sessionStorage.setItem("password", password);
    }

    function showMessage(text, type) {
        const messageEl = document.getElementById("message");
        messageEl.textContent = text;
        messageEl.className = "message";
        if (type === "success")      messageEl.classList.add("message-success");
        else if (type === "error")   messageEl.classList.add("message-error");
        else                         messageEl.classList.add("message-info");
    }

    document.addEventListener("DOMContentLoaded", () => {
        const form      = document.getElementById("wifiForm");
        const configBtn = document.getElementById("configBtn");
        const resetBtn  = document.getElementById("resetBtn");
        const scanBtn   = document.getElementById("scanBtn");
        const scanResult= document.getElementById("scanResult");

        restoreLastValues();

        resetBtn.addEventListener("click", () => {
            document.getElementById("ssid").value = "";
            document.getElementById("password").value = "";
            document.getElementById("encryption").value = "WPA";
            showMessage("ƒê√£ xo√° d·ªØ li·ªáu, m·ªùi nh·∫≠p l·∫°i.", "info");
        });

        // G·ª¨I C·∫§U H√åNH WIFI T·ªöI R1 (LOGIC GI·ªêNG B·∫¢N G·ªêC)
        form.addEventListener("submit", (e) => {
            e.preventDefault();

            const ssid       = document.getElementById("ssid").value.trim();
            const encryption = document.getElementById("encryption").value;
            const password   = document.getElementById("password").value.trim();

            if (!ssid) {
                showMessage("Vui l√≤ng nh·∫≠p t√™n WiFi (SSID).", "error");
                return;
            }
            if (encryption !== "INSECURE" && password.length < 8) {
                showMessage("M·∫≠t kh·∫©u ph·∫£i d√†i √≠t nh·∫•t 8 k√Ω t·ª± (tr·ª´ khi WiFi kh√¥ng m√£ h√≥a).", "error");
                return;
            }

            saveValues(ssid, encryption, password);

            const payload = {
                ssid: ssid,
                secure: encryption,
                password: password,
                mac: ""
            };

            configBtn.disabled = true;
            configBtn.textContent = "ƒêang g·ª≠i c·∫•u h√¨nh...";
            showMessage("ƒêang g·ª≠i c·∫•u h√¨nh t·ªõi loa R1, vui l√≤ng ƒë·ª£i...", "info");

            requestStarted = true;
            if (sendTimer) {
                clearTimeout(sendTimer);
            }
            sendTimer = setTimeout(() => {
                // N·∫øu sau 3 gi√¢y m√† request v·∫´n ch∆∞a xong => coi nh∆∞ timeout
                showMessage(
                    "H·∫øt th·ªùi gian ch·ªù. Ki·ªÉm tra xem ƒë√£ k·∫øt n·ªëi ƒë√∫ng WiFi R1 (Phicomm_R1_XXXX) " +
                    "v√† ƒë√£ t·∫Øt 4G/5G ch∆∞a.",
                    "error"
                );
                configBtn.disabled = false;
                configBtn.textContent = "G·ª≠i c·∫•u h√¨nh WiFi";
                requestStarted = false;
            }, 3000);

            // D√πng $.ajax gi·ªëng b·∫£n g·ªëc: data = JSON.stringify, kh√¥ng set contentType
            window.configwifi_ajax = $.ajax({
                type: 'POST',
                url: R1_API_URL,
                dataType: 'json',
                data: JSON.stringify(payload),
                success: function(res) {
                    console.log("R1 success:", res);
                    if (!requestStarted) return;
                    clearTimeout(sendTimer);
                    requestStarted = false;

                    showMessage(
                        "ƒê√£ g·ª≠i c·∫•u h√¨nh WiFi t·ªõi loa R1. N·∫øu loa b√°o 'k·∫øt n·ªëi th√†nh c√¥ng' l√† ok.",
                        "success"
                    );
                    configBtn.disabled = false;
                    configBtn.textContent = "G·ª≠i c·∫•u h√¨nh WiFi";
                },
                error: function(xhr, status, err) {
                    console.warn("R1 ajax error (c√≥ th·ªÉ CORS ho·∫∑c JSON):", status, err);

                    if (requestStarted) {
                        clearTimeout(sendTimer);
                        requestStarted = false;
                        showMessage(
                            "ƒê√£ g·ª≠i c·∫•u h√¨nh WiFi t·ªõi loa R1. Tr√¨nh duy·ªát b√°o l·ªói nh∆∞ng th∆∞·ªùng loa v·∫´n nh·∫≠n ƒë∆∞·ª£c, " +
                            "h√£y nghe loa xem c√≥ b√°o 'k·∫øt n·ªëi th√†nh c√¥ng' hay kh√¥ng.",
                            "success"
                        );
                        configBtn.disabled = false;
                        configBtn.textContent = "G·ª≠i c·∫•u h√¨nh WiFi";
                    } else {
                        showMessage(
                            "Kh√¥ng g·ª≠i ƒë∆∞·ª£c c·∫•u h√¨nh. H√£y ki·ªÉm tra k·∫øt n·ªëi WiFi R1 v√† th·ª≠ l·∫°i.",
                            "error"
                        );
                        configBtn.disabled = false;
                        configBtn.textContent = "G·ª≠i c·∫•u h√¨nh WiFi";
                    }
                }
            });
        });

        // QU√âT LAN: CH·ªà CHECK IP N√ÄO PH·∫¢N H·ªíI HTTP (KH√îNG QU√âT PORT 8989)
        async function scanLan() {
            const prefix = document.getElementById("lanPrefix").value.trim();
            const ipPattern = /^(\d{1,3}\.){2}\d{1,3}$/;

            if (!ipPattern.test(prefix)) {
                scanResult.innerHTML = "<span style='color:#f97316;'>Prefix kh√¥ng h·ª£p l·ªá. V√≠ d·ª• ƒë√∫ng: <strong>192.168.1</strong></span>";
                return;
            }

            scanBtn.disabled = true;
            scanBtn.textContent = "ƒêang qu√©t...";
            scanResult.textContent = "ƒêang qu√©t d·∫£i " + prefix + ".1‚Äì254 (HTTP)...";

            const alive = [];
            const maxHosts = 254;
            const timeoutMs = 600;
            const batchSize = 32;

            const checkIp = (ip) => {
                return new Promise((resolve) => {
                    // Qu√©t HTTP m·∫∑c ƒë·ªãnh (port 80) b·∫±ng fetch no-cors
                    const url = "http://" + ip + "/favicon.ico";
                    const controller = new AbortController();
                    const timeout = setTimeout(() => {
                        controller.abort();
                        resolve(null);
                    }, timeoutMs);

                    fetch(url, {mode: "no-cors", signal: controller.signal})
                        .then(() => {
                            clearTimeout(timeout);
                            resolve(ip);
                        })
                        .catch(() => {
                            clearTimeout(timeout);
                            resolve(null);
                        });
                });
            };

            for (let start = 1; start <= maxHosts; start += batchSize) {
                const tasks = [];
                for (let i = start; i < start + batchSize && i <= maxHosts; i++) {
                    const ip = `${prefix}.${i}`;
                    tasks.push(checkIp(ip));
                }
                const results = await Promise.all(tasks);
                results.forEach(ip => {
                    if (ip) alive.push(ip);
                });
            }

            if (alive.length === 0) {
                scanResult.innerHTML =
                    "<span style='color:#fb7185;'>Kh√¥ng t√¨m th·∫•y IP n√†o ph·∫£n h·ªìi HTTP trong d·∫£i " +
                    prefix + ".x. C√≥ th·ªÉ tr√¨nh duy·ªát ch·∫∑n qu√©t LAN, ho·∫∑c d·∫£i IP kh√¥ng ƒë√∫ng.</span>";
            } else {
                scanResult.innerHTML =
                    "C√°c IP c√≥ ph·∫£n h·ªìi HTTP trong d·∫£i " + prefix + ".x:<br>" +
                    "<strong>" + alive.join(", ") + "</strong>" +
                    "<br><span style='font-size:11px;color:#9ca3af;'>Trong s·ªë n√†y s·∫Ω c√≥ IP c·ªßa loa R1 (sau khi n√≥ v√†o WiFi nh√† b·∫°n). B·∫°n c√≥ th·ªÉ th·ª≠ l·∫ßn l∆∞·ª£t ho·∫∑c d√πng tool kh√°c ƒë·ªÉ x√°c ƒë·ªãnh ch√≠nh x√°c.</span>";
            }

            scanBtn.disabled = false;
            scanBtn.textContent = "Qu√©t IP trong LAN";
        }

        scanBtn.addEventListener("click", () => {
            scanLan();
        });
    });
</script>

</body>
</html>
